//
//  ShoppingListViewController.swift
//  RemeApp
//
//  Created by æœ¬å·æ™´å½¦ on 2023/[03/20.]
//
import UIKit
import RealmSwift

/// A-è²·ã„ç‰©ãƒªã‚¹ãƒˆ
class ShoppingListViewController: UIViewController {

    // MARK: - @IBOutlet
    /// è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹
    @IBOutlet private weak var shoppingListTableView: UITableView!

    // MARK: - property
    /// è²·ã„ç‰©ãƒªã‚¹ãƒˆã«è¡¨ç¤ºã™ã‚‹ãŠä½¿ã„ãƒ‡ãƒ¼ã‚¿ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
    private var errandDataList: [ErrandDataModel] = []

    // MARK: - viewDidLoad
    override func viewDidLoad() {
        super.viewDidLoad()
        shoppingListTableView.dataSource = self
        shoppingListTableView.delegate = self
        shoppingListTableView.register(UINib(nibName: "ShoppingListTableViewCell", bundle: nil),
                                       forCellReuseIdentifier: "ShoppingListTableViewCell")
        print("ğŸ¤ª")
    }

    override func viewWillAppear(_ animated: Bool) {
        super.viewWillAppear(animated)
        setErrandData()
        sortErrandDataList()
        shoppingListTableView.reloadData()
    }
    // MARK: - func

    /// ä¿å­˜ã•ã‚ŒãŸãŠä½¿ã„ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆã™ã‚‹
    func setErrandData() {
        let realm = try! Realm()
        let result = realm.objects(ErrandDataModel.self)
        errandDataList = Array(result)
    }

    /// cellã‚’ãƒã‚§ãƒƒã‚¯ãŒã‚ªãƒ•ã®ã‚‚ã®ã‚’ä¸€ç•ªä¸Šã«ã€ã‹ã¤å£²ã‚Šå ´ã®é †ã«ä¸¦ã³æ›¿ãˆã‚‹
    /// - UserDefaultsã«ä½¿ç”¨ã™ã‚‹ã‚­ãƒ¼ã‚’æŒ‡å®š
    /// - UserDefaultsã‹ã‚‰è¨­å®šã‚’å–å¾—
    /// -  ç”»é¢ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ™‚ã®è¡¨ç¤ºã‚’ifæ–‡ã§åˆ‡ã‚Šæ›¿ãˆ
    /// - è²·ã„ç‰©é–‹å§‹ä½ç½®ãŒå·¦å›ã‚Šè¨­å®šã®å ´åˆ -> cellã‚’ãƒã‚§ãƒƒã‚¯ãŒã‚ªãƒ•ã®ã‚‚ã®ã‚’ä¸€ç•ªä¸Šã«ã€ã‹ã¤å£²ã‚Šå ´ã‚’é™é †ã«ä¸¦ã³æ›¿ãˆã‚‹
    /// - è²·ã„ç‰©é–‹å§‹ä½ç½®ãŒå³å›ã‚Šè¨­å®šã®å ´åˆ -> ellã‚’ãƒã‚§ãƒƒã‚¯ãŒã‚ªãƒ•ã®ã‚‚ã®ã‚’ä¸€ç•ªä¸Šã«ã€ã‹ã¤å£²ã‚Šå ´ã‚’æ˜‡é †ã«ä¸¦ã³æ›¿ãˆã‚‹
    private func sortErrandDataList() {
        let shoppingStartPositionKey = "shoppingStartPositionKey"
        let shoppingStartPositionInt = UserDefaults.standard.integer(forKey: shoppingStartPositionKey)
        if shoppingStartPositionInt == 0 {
            sortLeftErrandDataList()
        } else {
            sortRightErrandDataList()
        }
    }

    /// è²·ã„ç‰©ãƒ«ãƒ¼ãƒˆã‚’å·¦å›ã‚Šã«é¸æŠã•ã‚ŒãŸå ´åˆã®è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’ä¸¦ã³æ›¿ãˆã‚‹
    /// - cellã‚’ãƒã‚§ãƒƒã‚¯ãŒã‚ªãƒ•ã®ã‚‚ã®ã‚’ä¸€ç•ªä¸Šã«ã€ã‹ã¤å£²ã‚Šå ´ã‚’é™é †ã«ä¸¦ã³æ›¿ãˆã‚‹
    /// - shoppingListTableViewã‚’å†èª­ã¿è¾¼ã¿
    func sortLeftErrandDataList() {
        errandDataList = errandDataList.sorted { (a, b) -> Bool in
            if a.isCheckBox != b.isCheckBox {
                return !a.isCheckBox
            } else {
                return a.salesFloorRawValue > b.salesFloorRawValue
            }
        }
        shoppingListTableView.reloadData()
    }

    /// è²·ã„ç‰©ãƒ«ãƒ¼ãƒˆã‚’å³å›ã‚Šã«é¸æŠã•ã‚ŒãŸå ´åˆã®è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’ä¸¦ã³æ›¿ãˆã‚‹
    /// - cellã‚’ãƒã‚§ãƒƒã‚¯ãŒã‚ªãƒ•ã®ã‚‚ã®ã‚’ä¸€ç•ªä¸Šã«ã€ã‹ã¤å£²ã‚Šå ´ã‚’æ˜‡é †ã«ä¸¦ã³æ›¿ãˆã‚‹
    /// - shoppingListTableViewã‚’å†èª­ã¿è¾¼ã¿
    func sortRightErrandDataList() {
        errandDataList = errandDataList.sorted { (a, b) -> Bool in
            if a.isCheckBox != b.isCheckBox {
                return !a.isCheckBox
            } else {
                return a.salesFloorRawValue < b.salesFloorRawValue
            }
        }
        shoppingListTableView.reloadData()
    }

    /// å…¨ã¦ã®ã‚»ãƒ«ãŒãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã«ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤ºã™ã‚‹
   private func completionAlert() {
        if errandDataList.allSatisfy({ $0.isCheckBox }) {
            let alertController = UIAlertController(title: "è²·ã„ç‰©ãŒå®Œäº†ã—ã¾ã—ãŸï¼", message: nil, preferredStyle: .alert)
            let okAction = UIAlertAction(title: "OK", style: .default, handler: nil)
            alertController.addAction(okAction)
            present(alertController, animated: true, completion: nil)
        }
    }
}

// MARK: - UITableViewDataSource&Delegate
extension ShoppingListViewController: UITableViewDataSource, UITableViewDelegate {
    /// shoppingListTableViewã«è¡¨ç¤ºã™ã‚‹cellæ•°ã‚’æŒ‡å®š
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return errandDataList.count
    }
    
    /// shoppingListTableViewã«ä½¿ç”¨ã™ã‚‹cellã®å†…å®¹ã‚’æŒ‡å®š
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        if let cell = shoppingListTableView.dequeueReusableCell(
            withIdentifier: "ShoppingListTableViewCell", for: indexPath) as? ShoppingListTableViewCellController {
            cell.delegate = self
            let errandDataModel: ErrandDataModel = errandDataList[indexPath.row]
            cell.setShoppingList(isCheckBox: errandDataModel.isCheckBox,
                                 nameOfItem: errandDataModel.nameOfItem,
                                 numberOfItem: errandDataModel.numberOfItem,
                                 unit: errandDataModel.unit,
                                 salesFloorRawValue: errandDataModel.salesFloorRawValue,
                                 supplement: errandDataModel.supplement,
                                 image: errandDataModel.getImage())
            return cell
        }
        return UITableViewCell()
    }

    /// shoppingListTableViewã®cellãŒã‚¿ãƒƒãƒ—ã•ã‚ŒãŸæ™‚ã®æŒ™å‹•ã‚’å®šç¾©
    /// - ã‚¿ãƒƒãƒ—ã•ã‚ŒãŸå•†å“ã®ãƒ‡ãƒ¼ã‚¿ã‚’detailShoppingListViewControllerã«æ¸¡ã™
    /// - detailShoppingListViewControllerã«ãƒ—ãƒƒã‚·ãƒ¥é·ç§»
    func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
        let storyboard = UIStoryboard(name: "DetailShoppingListView", bundle: nil)
        let detailShoppingListViewController = storyboard.instantiateViewController(
            withIdentifier: "DetailShoppingListView") as! DetailShoppingListViewController
        let errandData = errandDataList[indexPath.row]
        detailShoppingListViewController.configurer(detail: errandData)
        shoppingListTableView.deselectRow(at: indexPath, animated: true)
        detailShoppingListViewController.modalPresentationStyle = .overCurrentContext // é‡ãªã‚Šåˆã†ã‚ˆã†ã«è¡¨ç¤º
        detailShoppingListViewController.modalTransitionStyle = .crossDissolve // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ãƒ»ã‚¢ã‚¦ãƒˆã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³

        self.present(detailShoppingListViewController, animated: true)
    }
}

// MARK: - ShoppingListTableViewCellDelegate
// cellå†…ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¿ãƒƒãƒ—ã—ãŸéš›ã®å‡¦ç†
extension ShoppingListViewController: ShoppingListTableViewCellDelegate {
    /// cellå†…ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¿ãƒƒãƒ—ã—ãŸéš›ã®å‡¦ç†
    /// - ãƒã‚§ãƒƒã‚¯ã—ãŸã‚‚ã®ã¯ä¸‹ã«ç§»å‹•ã™ã‚‹
    /// - å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒã¤ã„ãŸã‚‰ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã™
    /// - ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ“ãƒ¥ãƒ¼ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦è¡¨ç¤ºã™ã‚‹
    func didTapCheckBoxButton(_ cell: ShoppingListTableViewCellController) {
        guard let indexPath = shoppingListTableView.indexPath(for: cell) else { return }
        let isChecked = !errandDataList[indexPath.row].isCheckBox
        // Realmã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
        let realm = try! Realm()
        realm.beginWrite()
        errandDataList[indexPath.row].isCheckBox = isChecked
        realm.add(errandDataList[indexPath.row], update: .modified)
        do {
            try realm.commitWrite()
        } catch {
            print("Error committing write transaction: \\(error)")
        }
        sortErrandDataList()
        completionAlert()
        shoppingListTableView.reloadData()
    }
}
